<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>RAG 应用流式测试页面</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			margin: 0;
			padding: 20px;
			background-color: #f4f7f9;
			color: #333;
			display: flex;
			justify-content: center;
			align-items: flex-start;
			gap: 20px;
		}
		.container {
			background-color: #fff;
			padding: 25px;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			width: 100%;
			max-width: 500px;
		}
		h2 {
			border-bottom: 2px solid #eef;
			padding-bottom: 10px;
			margin-top: 0;
			color: #444;
		}
		button {
			background-color: #007bff;
			color: white;
			border: none;
			padding: 12px 18px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.3s;
		}
		button:disabled {
			background-color: #cccccc;
			cursor: not-allowed;
		}
		#chat-window {
			height: 400px;
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 15px;
			overflow-y: auto;
			margin-bottom: 15px;
			background-color: #f9f9f9;
			display: flex;
			flex-direction: column;
		}
		.chat-message {
			margin-bottom: 15px;
			padding: 10px 15px;
			border-radius: 12px;
			max-width: 85%;
			word-wrap: break-word;
			line-height: 1.5;
		}
		.user-message {
			background-color: #007bff;
			color: white;
			align-self: flex-end;
		}
		.assistant-message {
			background-color: #e9ecef;
			color: #333;
			align-self: flex-start;
		}
		.chat-input-area {
			display: flex;
			gap: 10px;
		}
		#chat-input {
			flex-grow: 1;
			padding: 10px;
			border: 1px solid #ccc;
			border-radius: 4px;
			font-size: 16px;
		}
	</style>
</head>
<body>

<div class="container" id="upload-container">
</div>

<div class="container" id="chat-container">
	<h2>与智能助手对话</h2>
	<div id="chat-window">
		<div class="chat-message assistant-message">
			你好！请向我提问。
		</div>
	</div>
	<div class="chat-input-area">
		<input type="text" id="chat-input" placeholder="输入您的问题...">
		<button id="send-button">发送</button>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		const sendButton = document.getElementById('send-button');
		const chatInput = document.getElementById('chat-input');
		const chatWindow = document.getElementById('chat-window');
		
		const handleSendMessage = async () => {
			const message = chatInput.value.trim();
			if (!message) return;
			
			// 1. 在UI上显示用户消息并禁用输入
			appendMessage(message, 'user-message');
			const question = chatInput.value;
			chatInput.value = '';
			setChattingState(true);
			
			// 2. 为AI的回复创建一个新的消息占位符
			const assistantMessageElement = createMessageElement('assistant-message');
			
			try {
				// 3. 发起POST请求以获取流式响应
				const response = await fetch('/api/assistant/chat', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ message: question }),
				});
				
				if (!response.ok || !response.body) {
					throw new Error(`请求失败，状态码: ${response.status}`);
				}
				
				const reader = response.body.getReader();
				const decoder = new TextDecoder("utf-8");
				
				// 4. 循环读取和处理流数据
				while (true) {
					const { done, value } = await reader.read();
					if (done) break; // 流结束
					
					const chunk = decoder.decode(value, { stream: true });
					// SSE数据块可能包含多个事件，需要按行解析
					const lines = chunk.split('\n');
					
					for (const line of lines) {
						// 只处理以 "data:" 开头的行
						if (line.startsWith("data:")) {
							const data = line.substring(5).trim();
							// 核心：实时将token追加到AI消息框的textContent中
							assistantMessageElement.textContent += data;
							// 实时滚动到底部，确保用户能看到最新内容
							chatWindow.scrollTop = chatWindow.scrollHeight;
						}
					}
				}
			} catch (error) {
				assistantMessageElement.textContent = "抱歉，处理您的请求时发生了错误。";
				console.error("流式聊天失败:", error);
			} finally {
				// 5. 请求结束后，无论成功失败，都恢复UI状态
				setChattingState(false);
			}
		};
		
		// --- 事件监听 ---
		sendButton.addEventListener('click', handleSendMessage);
		chatInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') handleSendMessage();
		});
		
		// --- 辅助函数 ---
		function setChattingState(isChatting) {
			chatInput.disabled = isChatting;
			sendButton.disabled = isChatting;
			if (!isChatting) chatInput.focus();
		}
		
		function createMessageElement(className) {
			const messageElement = document.createElement('div');
			messageElement.classList.add('chat-message', className);
			chatWindow.appendChild(messageElement);
			chatWindow.scrollTop = chatWindow.scrollHeight;
			return messageElement;
		}
		
		function appendMessage(text, className) {
			const messageElement = createMessageElement(className);
			messageElement.textContent = text;
		}
	});
</script>

</body>
</html>
