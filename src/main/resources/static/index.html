<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>智能助手</title>
	<style>
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			margin: 0;
			padding: 20px;
			background-color: #f4f7f9;
			color: #333;
			display: flex;
			justify-content: center;
			align-items: flex-start;
			gap: 20px;
			flex-wrap: wrap;
		}
		.container {
			background-color: #fff;
			padding: 25px;
			border-radius: 8px;
			box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
			width: 100%;
			max-width: 500px;
			display: flex;
			flex-direction: column;
			gap: 15px;
		}
		h2 {
			border-bottom: 2px solid #eef;
			padding-bottom: 10px;
			margin-top: 0;
			color: #444;
		}
		button {
			background-color: #007bff;
			color: white;
			border: none;
			padding: 12px 18px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			transition: background-color 0.3s;
		}
		button:disabled {
			background-color: #cccccc;
			cursor: not-allowed;
		}
		#chat-window {
			height: 400px;
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 15px;
			overflow-y: auto;
			background-color: #f9f9f9;
			display: flex;
			flex-direction: column;
		}
		.chat-message { margin-bottom: 15px; padding: 10px 15px; border-radius: 12px; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
		.user-message { background-color: #007bff; color: white; align-self: flex-end; }
		.assistant-message { background-color: #e9ecef; color: #333; align-self: flex-start; }
		.chat-input-area { display: flex; gap: 10px; }
		#chat-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
		.tool-selection, .session-controls { display: flex; flex-direction: column; gap: 10px; }
		.tool-selection fieldset { border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
		.tool-selection legend { font-weight: bold; color: #555; }
		.tool-selection label { display: block; }
	</style>
</head>
<body>

<div class="container" id="controls-container">
	<div class="session-controls">
		<h2>会话控制</h2>
		<button id="new-chat-button">开启新对话</button>
	</div>
	<div class="tool-selection">
		<fieldset>
			<legend>选择要启用的插件</legend>
			<label><input type="checkbox" name="tool" value="calculatorTool"> 计算器</label>
			<label><input type="checkbox" name="tool" value="webScraperTool"> 网页抓取</label>
			<label><input type="checkbox" name="tool" value="terminalTool"> 终端 (只读)</label>
			<label style="color: #888;"><input type="checkbox" checked disabled> 知识库 (默认启用)</label>
		</fieldset>
	</div>
</div>

<div class="container" id="chat-container">
	<h2>与智能助手对话</h2>
	<div id="chat-window"></div>
	<div class="chat-input-area">
		<input type="text" id="chat-input" placeholder="输入您的问题...">
		<button id="send-button">发送</button>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function() {
		// --- DOM Elements ---
		const sendButton = document.getElementById('send-button');
		const chatInput = document.getElementById('chat-input');
		const chatWindow = document.getElementById('chat-window');
		const newChatButton = document.getElementById('new-chat-button');
		const toolCheckboxes = document.querySelectorAll('input[name="tool"]');
		
		// --- State Management ---
		let conversationId = null;
		
		// --- Functions ---
		const startNewChat = () => {
			conversationId = crypto.randomUUID(); // Generate a new unique ID for the conversation
			chatWindow.innerHTML = ''; // Clear the chat window
			appendMessage('你好！一个全新的对话已开始。请问有什么可以帮您？', 'assistant-message');
			console.log(`New chat started. Conversation ID: ${conversationId}`);
		};
		
		const getSelectedTools = () => {
			return Array.from(toolCheckboxes)
					.filter(checkbox => checkbox.checked)
					.map(checkbox => checkbox.value);
		};
		
		const handleSendMessage = async () => {
			const message = chatInput.value.trim();
			if (!message) return;
			
			appendMessage(message, 'user-message');
			const question = chatInput.value;
			chatInput.value = '';
			setChattingState(true);
			
			const assistantMessageElement = createMessageElement('assistant-message');
			
			const requestBody = {
				conversationId: conversationId,
				message: question,
				tools: getSelectedTools()
			};
			
			try {
				const response = await fetch('/api/assistant/chat', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify(requestBody),
				});
				
				if (!response.ok || !response.body) {
					throw new Error(`请求失败: ${response.status}`);
				}
				
				const reader = response.body.getReader();
				const decoder = new TextDecoder("utf-8");
				
				while (true) {
					const { done, value } = await reader.read();
					if (done) break;
					
					const chunk = decoder.decode(value, { stream: true });
					const lines = chunk.split('\n');
					
					for (const line of lines) {
						if (line.startsWith("data:")) {
							const data = line.substring(5).trim();
							if (data) {
								assistantMessageElement.textContent += JSON.parse(`"${data}"`); // Safely parse potential escape sequences
							}
							chatWindow.scrollTop = chatWindow.scrollHeight;
						}
					}
				}
			} catch (error) {
				assistantMessageElement.textContent = `抱歉，处理您的请求时发生了错误: ${error.message}`;
				console.error("流式聊天失败:", error);
			} finally {
				setChattingState(false);
			}
		};
		
		const setChattingState = (isChatting) => {
			chatInput.disabled = isChatting;
			sendButton.disabled = isChatting;
			if (!isChatting) chatInput.focus();
		};
		
		const createMessageElement = (className) => {
			const messageElement = document.createElement('div');
			messageElement.classList.add('chat-message', className);
			chatWindow.appendChild(messageElement);
			chatWindow.scrollTop = chatWindow.scrollHeight;
			return messageElement;
		};
		
		const appendMessage = (text, className) => {
			const messageElement = createMessageElement(className);
			messageElement.textContent = text;
		};
		
		// --- Event Listeners ---
		sendButton.addEventListener('click', handleSendMessage);
		chatInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') handleSendMessage();
		});
		newChatButton.addEventListener('click', startNewChat);
		
		// --- Initialisation ---
		startNewChat(); // Start a new chat session when the page loads
	});
</script>

</body>
</html>
